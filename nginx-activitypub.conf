# Configuração Nginx para Proxy Reverso ActivityPub
# 
# Esta configuração deve ser adicionada ao servidor nginx que serve fromabyss.com
# Ela faz proxy reverso de todos os endpoints ActivityPub para api.fromabyss.com
# mantendo as URLs como fromabyss.com (necessário para o fediverse funcionar)
#
# Como usar:
# 1. Adicione estas regras ao seu arquivo de configuração nginx para fromabyss.com
# 2. Ou inclua este arquivo usando: include /path/to/nginx-activitypub.conf;
# 3. Reinicie o nginx: sudo systemctl reload nginx

# Proxy para /.well-known/webfinger (descoberta de usuários)
location /.well-known/webfinger {
    proxy_pass https://api.fromabyss.com;
    proxy_set_header Host api.fromabyss.com;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    
    # Headers importantes para ActivityPub
    proxy_set_header Accept application/jrd+json, application/activity+json, application/ld+json;
    
    # Timeout aumentado para requisições ActivityPub
    proxy_connect_timeout 30s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;
}

# Proxy para /.well-known/nodeinfo (descoberta de informações do servidor)
location /.well-known/nodeinfo {
    proxy_pass https://api.fromabyss.com;
    proxy_set_header Host api.fromabyss.com;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    
    proxy_connect_timeout 30s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;
}

# Proxy para /nodeinfo/* (informações detalhadas do servidor)
location /nodeinfo/ {
    proxy_pass https://api.fromabyss.com;
    proxy_set_header Host api.fromabyss.com;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    
    proxy_connect_timeout 30s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;
}

# Proxy para /actors/* (perfis de usuários e endpoints relacionados)
location /actors/ {
    proxy_pass https://api.fromabyss.com;
    proxy_set_header Host api.fromabyss.com;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    
    # Headers importantes para ActivityPub
    proxy_set_header Accept application/activity+json, application/ld+json, application/json;
    proxy_set_header Content-Type application/activity+json;
    
    # Permitir métodos HTTP necessários
    proxy_method GET;
    proxy_method POST;
    
    # Timeout aumentado
    proxy_connect_timeout 30s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;
    
    # Buffer para requisições grandes (ActivityPub pode ter payloads grandes)
    proxy_buffering on;
    proxy_buffer_size 4k;
    proxy_buffers 8 4k;
    proxy_busy_buffers_size 8k;
}

# Proxy para /inbox (shared inbox - recebe atividades de outras instâncias)
location /inbox {
    proxy_pass https://api.fromabyss.com;
    proxy_set_header Host api.fromabyss.com;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    
    # Headers importantes para ActivityPub
    proxy_set_header Accept application/activity+json, application/ld+json;
    proxy_set_header Content-Type application/activity+json;
    
    # Permitir apenas POST para inbox
    limit_except POST {
        deny all;
    }
    
    # Timeout aumentado
    proxy_connect_timeout 30s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;
    
    # Buffer para requisições grandes
    proxy_buffering on;
    proxy_buffer_size 8k;
    proxy_buffers 16 8k;
    proxy_busy_buffers_size 16k;
}

# Nota: Os endpoints /outbox, /followers, /following são subcaminhos de /actors/
# então já são cobertos pela regra /actors/ acima
